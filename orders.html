{% extends "base.html" %}
{% block content %}
<div class="container my-5">
  <h2 class="text-center mb-4">My Orders</h2>
  <div id="ordersList"></div>
</div>

<script>
const apiBase = "https://ecommerce-backend-2-qntk.onrender.com/api/";
const token = localStorage.getItem("access_token"); // match your main.js key

if (!token) {
  alert("Please login to view your orders.");
  window.location.href = "login.html";
}

// Fetch orders from backend
async function fetchOrders() {
  try {
    const res = await fetch(`${apiBase}orders/`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!res.ok) throw new Error("Failed to fetch orders");
    const orders = await res.json();
    renderOrders(orders);
  } catch (err) {
    document.getElementById("ordersList").innerHTML = "<p>No orders found.</p>";
  }
}

// Render orders
function renderOrders(orders) {
  const container = document.getElementById("ordersList");
  container.innerHTML = "";

  if (orders.length === 0) {
    container.innerHTML = "<p>You have no orders yet.</p>";
    return;
  }

  orders.forEach(order => {
    let itemsHtml = "";
    order.items.forEach(item => {
      const imageUrl = item.product.image.startsWith("http")
        ? item.product.image
        : apiBase.replace("/api/", "") + item.product.image;

      itemsHtml += `
        <li>
          <img src="${imageUrl}" alt="${item.product.name}" style="width:40px; height:40px; object-fit:cover; margin-right:5px;">
          ${item.product.name} (x${item.quantity}) - $${item.product.price}
        </li>
      `;
    });

    container.innerHTML += `
      <div class="card mb-3">
        <div class="card-body">
          <h5>Order #${order.id}</h5>
          <p><strong>Status:</strong> ${order.status}</p>
          <p><strong>Total:</strong> $${order.total}</p>
          <p><strong>Date:</strong> ${new Date(order.created_at).toLocaleString()}</p>
          <ul>${itemsHtml}</ul>
        </div>
      </div>
    `;
  });
}

// Initialize
fetchOrders();
</script>
{% endblock %}
